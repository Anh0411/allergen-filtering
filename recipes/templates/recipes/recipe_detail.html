{% extends 'base.html' %}
{% block content %}
<div class="flex flex-col items-center justify-center min-h-screen py-10">
  <div class="bg-[#F0EBE1] rounded-2xl max-w-4xl w-full p-8 flex flex-col items-center border"
    style="border-color:rgba(38,37,34,0.24);">
    
    <!-- Recipe Header -->
    <div class="w-full mb-6">
      <h1 class="text-4xl font-bold text-center mb-4 text-gray-900">{{ recipe.title }}</h1>
      
      <!-- Enhanced Risk Level Badge -->
      <div class="flex justify-center mb-4">
        {% if recipe.analysis_result.risk_level == 'low' %}
        <div class="bg-green-50 border border-green-200 rounded-xl p-4 max-w-md">
          <div class="flex items-center justify-center mb-2">
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-green-100 text-green-800 border border-green-300">
              <span class="w-3 h-3 bg-green-400 rounded-full mr-2"></span>
              ‚úÖ Safe to Consume
            </span>
          </div>
          <p class="text-sm text-green-700 text-center">This recipe appears to be allergen-free based on our analysis.</p>
          
          {% if can_annotate and existing_annotation %}
          <div class="mt-3 pt-3 border-t border-green-200">
            <div class="flex items-center justify-center text-xs text-green-600">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              You have annotated this recipe
            </div>
          </div>
          {% endif %}
        </div>
        {% elif recipe.analysis_result.risk_level == 'medium' %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 max-w-md">
          <div class="flex items-center justify-center mb-2">
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800 border border-yellow-300">
              <span class="w-3 h-3 bg-yellow-400 rounded-full mr-2"></span>
              ‚ö†Ô∏è Exercise Caution
            </span>
          </div>
          <p class="text-sm text-yellow-700 text-center">Contains potential allergens. Review ingredients carefully.</p>
          
          {% if can_annotate and existing_annotation %}
          <div class="mt-3 pt-3 border-t border-yellow-200">
            <div class="flex items-center justify-center text-xs text-yellow-600">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              You have annotated this recipe
            </div>
          </div>
          {% endif %}
        </div>
        {% elif recipe.analysis_result.risk_level == 'high' %}
        <div class="bg-orange-50 border border-orange-200 rounded-xl p-4 max-w-md">
          <div class="flex items-center justify-center mb-2">
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-orange-100 text-orange-800 border border-orange-300">
              <span class="w-3 h-3 bg-orange-400 rounded-full mr-2"></span>
              ‚ö†Ô∏è High Risk
            </span>
          </div>
          <p class="text-sm text-orange-700 text-center">Multiple allergens detected. Not recommended for allergy sufferers.</p>
          
          {% if can_annotate and existing_annotation %}
          <div class="mt-3 pt-3 border-t border-orange-200">
            <div class="flex items-center justify-center text-xs text-orange-600">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              You have annotated this recipe
            </div>
          </div>
          {% endif %}
        </div>
        {% elif recipe.analysis_result.risk_level == 'critical' %}
        <div class="bg-red-50 border border-red-200 rounded-xl p-4 max-w-md">
          <div class="flex items-center justify-center mb-2">
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-red-100 text-red-800 border border-red-300">
              <span class="w-3 h-3 bg-red-400 rounded-full mr-2"></span>
              üö® Critical Risk
            </span>
          </div>
          <p class="text-sm text-red-700 text-center">Contains major allergens. Avoid if you have food allergies.</p>
          
          {% if can_annotate and existing_annotation %}
          <div class="mt-3 pt-3 border-t border-red-200">
            <div class="flex items-center justify-center text-xs text-red-600">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              You have annotated this recipe
            </div>
          </div>
          {% endif %}
        </div>
        {% else %}
        <!-- Fallback for recipes without analysis -->
        <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 max-w-md">
          <div class="flex items-center justify-center mb-2">
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-gray-100 text-gray-800 border border-gray-300">
              <span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>
              ‚ö†Ô∏è Not Analyzed
            </span>
          </div>
          <p class="text-sm text-gray-700 text-center">This recipe has not been analyzed for allergens yet.</p>
          
          {% if can_annotate and existing_annotation %}
          <div class="mt-3 pt-3 border-t border-gray-200">
            <div class="flex items-center justify-center text-xs text-gray-600">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              You have annotated this recipe
            </div>
          </div>
          {% endif %}
        </div>
        {% endif %}
      </div>
      
      <!-- Enhanced Confidence Score -->
      {% if recipe.analysis_result.confidence_scores %}
      <div class="flex justify-center mb-4">
        <div class="bg-white rounded-xl px-6 py-4 shadow-sm border border-gray-200">
          <div class="flex items-center space-x-4">
            <div>
              <span class="text-sm text-gray-600">Analysis Confidence:</span>
              <span class="font-bold text-gray-900 ml-2">
                {% for allergen, score in recipe.analysis_result.confidence_scores.items %}
                    {% if forloop.first %}{% widthratio score 1 100 %}{% endif %}
                {% endfor %}
              </span>
            </div>
            <div class="w-32 bg-gray-200 rounded-full h-3">
              <div class="bg-yellow-600 h-3 rounded-full transition-all duration-300 confidence-bar" 
                   data-confidence="{% for allergen, score in recipe.analysis_result.confidence_scores.items %}{% if forloop.first %}{% widthratio score 1 100 %}{% endif %}{% endfor %}"></div>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-1 text-center">
            {% for allergen, score in recipe.analysis_result.confidence_scores.items %}
                {% if forloop.first %}
                    {% widthratio score 1 100 as percentage %}
                    {% if percentage >= 80 %}
                      High confidence analysis
                    {% elif percentage >= 60 %}
                      Moderate confidence analysis
                    {% else %}
                      Low confidence - manual review recommended
                    {% endif %}
                {% endif %}
            {% endfor %}
          </p>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Recipe Image -->
    {% if recipe.image_url %}
    <div class="relative">
        <img src="{{ recipe.image_url }}" alt="{{ recipe.title }}"
          class="w-full h-72 object-cover rounded-xl mb-6 border border-yellow-100 shadow-sm bg-gray-100" loading="lazy">
        <!-- Debug info (only visible in development) -->
        {% if debug %}
        <div class="absolute top-2 left-2 bg-black bg-opacity-75 text-white text-xs px-2 py-1 rounded">
            Image URL: {{ recipe.image_url|truncatechars:30 }}
        </div>
        {% endif %}
    </div>
    {% else %}
    <!-- No image placeholder -->
    <div class="w-full h-72 bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl mb-6 border border-yellow-100 shadow-sm flex items-center justify-center">
        <div class="text-center">
            <svg class="w-16 h-16 text-yellow-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <p class="text-gray-500 text-sm">No image available</p>
        </div>
    </div>
    {% endif %}

    <!-- Allergen Summary Section -->
    {% if detected_allergens %}
    <div class="w-full mb-6">
      <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-xl p-6">
        <h2 class="text-xl font-semibold mb-4 text-red-800 flex items-center">
          <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
          Allergen Summary
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="bg-white rounded-lg p-4 border border-red-100">
            <h3 class="font-semibold text-red-800 mb-2">Detected Allergens</h3>
            <div class="flex flex-wrap gap-2">
              {% for allergen in detected_allergens %}
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800 border border-red-200">
                {{ allergen.category.name }}
                <span class="ml-1 text-xs text-red-600">({% widthratio allergen.confidence 1 100 %}%)</span>
              </span>
              {% endfor %}
            </div>
          </div>
          
          <div class="bg-white rounded-lg p-4 border border-red-100">
            <h3 class="font-semibold text-red-800 mb-2">Risk Assessment</h3>
            <div class="space-y-2">
              <div class="flex justify-between">
                <span class="text-sm text-gray-600">Total Allergens:</span>
                <span class="font-medium">{{ detected_allergens|length }}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-sm text-gray-600">Highest Confidence:</span>
                <span class="font-medium">{% widthratio detected_allergens.0.confidence 1 100 %}%</span>
              </div>
              <div class="flex justify-between">
                <span class="text-sm text-gray-600">Risk Level:</span>
                <span class="font-medium capitalize">{{ recipe.analysis_result.risk_level }}</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Quick Safety Recommendation -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <h3 class="font-semibold text-yellow-800 mb-2 flex items-center">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Safety Recommendation
          </h3>
          {% if recipe.analysis_result.risk_level == 'medium' %}
          <p class="text-sm text-yellow-700">Review all ingredients carefully and consider consulting with a healthcare provider if you have food allergies.</p>
          {% elif recipe.analysis_result.risk_level == 'high' %}
          <p class="text-sm text-yellow-700">This recipe contains multiple allergens. Consider finding an alternative recipe or consulting with a healthcare provider.</p>
          {% elif recipe.analysis_result.risk_level == 'critical' %}
          <p class="text-sm text-yellow-700">This recipe contains major allergens and is not recommended for individuals with food allergies. Please find an alternative recipe.</p>
          {% endif %}
        </div>
      </div>
    </div>
    {% elif not allergen_analysis %}
    <div class="w-full mb-6">
      <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 flex flex-col items-center">
        <svg class="w-10 h-10 text-blue-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h2 class="text-lg font-semibold text-blue-800 mb-2">No Allergen Analysis Available</h2>
        <p class="text-sm text-blue-700 text-center">This recipe has not yet been analyzed for allergens. Please check back later or contact an administrator to request analysis.</p>
      </div>
    </div>
    {% endif %}

    <!-- Allergen Analysis Section -->
    {% if detected_allergens %}
    <div class="w-full mb-8">
      <div class="bg-red-50 border border-red-200 rounded-xl p-6">
        <h2 class="text-xl font-semibold mb-4 text-red-800 flex items-center">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
          Detailed Allergen Analysis
        </h2>
        
        <div class="space-y-4">
          {% for allergen in detected_allergens %}
          <div class="bg-white rounded-lg p-4 border border-red-100 shadow-sm">
            <div class="flex justify-between items-start mb-3">
              <div class="flex items-center">
                <h3 class="font-semibold text-red-800 text-lg">{{ allergen.category.name }}</h3>
                {% widthratio allergen.confidence 1 100 as percentage %}
                {% if percentage >= 80 %}
                <span class="ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  High Confidence
                </span>
                {% elif percentage >= 60 %}
                <span class="ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                  Moderate Confidence
                </span>
                {% else %}
                <span class="ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                  Low Confidence
                </span>
                {% endif %}
              </div>
              <div class="text-right">
                <div class="text-sm text-gray-600 mb-1">Confidence Score</div>
                <div class="flex items-center justify-end space-x-3">
                  <div class="text-lg font-bold text-gray-900">{% widthratio allergen.confidence 1 100 %}%</div>
                  <div class="w-20 bg-gray-200 rounded-full h-2">
                    <div class="bg-red-500 h-2 rounded-full allergen-confidence-bar" 
                         data-confidence="{% widthratio allergen.confidence 1 100 %}"></div>
                  </div>
                </div>
              </div>
            </div>
            
            {% if allergen.description %}
            <div class="mb-3 p-3 bg-gray-50 rounded-lg">
              <p class="text-sm text-gray-700">{{ allergen.description }}</p>
            </div>
            {% endif %}
            
            {% if allergen.terms %}
            <div class="mb-3">
              <h4 class="text-sm font-medium text-gray-700 mb-2">Detected Terms:</h4>
              <div class="flex flex-wrap gap-2">
                {% for term in allergen.terms %}
                <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-50 text-red-700 border border-red-200">
                  {{ term }}
                </span>
                {% endfor %}
              </div>
            </div>
            {% endif %}
            
            <!-- Common Sources -->
            <div class="text-xs text-gray-500">
              <span class="font-medium">Common sources:</span> 
              {% if allergen.category.name == 'Milk' %}
                Dairy products, cheese, butter, cream, yogurt
              {% elif allergen.category.name == 'Eggs' %}
                Eggs, mayonnaise, baked goods, pasta
              {% elif allergen.category.name == 'Peanuts' %}
                Peanut butter, peanut oil, mixed nuts, Asian cuisine
              {% elif allergen.category.name == 'Tree Nuts' %}
                Almonds, walnuts, pecans, cashews, hazelnuts
              {% elif allergen.category.name == 'Soy' %}
                Soy sauce, tofu, edamame, soy milk, processed foods
              {% elif allergen.category.name == 'Wheat' %}
                Bread, pasta, flour, cereals, baked goods
              {% elif allergen.category.name == 'Fish' %}
                Fish, fish sauce, sushi, seafood dishes
              {% elif allergen.category.name == 'Shellfish' %}
                Shrimp, crab, lobster, clams, oysters
              {% elif allergen.category.name == 'Sulfites' %}
                Wine, dried fruits, processed meats, pickled foods
              {% elif allergen.category.name == 'Sesame' %}
                Sesame oil, tahini, sesame seeds, Asian cuisine
              {% elif allergen.category.name == 'Mustard' %}
                Mustard, mustard powder, condiments, dressings
              {% else %}
                Various food products and ingredients
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
        
        <!-- Enhanced Recommendations -->
        {% if allergen_analysis.recommendations %}
        <div class="mt-6 bg-gradient-to-r from-yellow-50 to-orange-50 border border-yellow-200 rounded-lg p-4">
          <h3 class="font-semibold text-yellow-800 mb-3 flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Recommendations & Safety Tips
          </h3>
          <ul class="space-y-2">
            {% for recommendation in allergen_analysis.recommendations %}
            <li class="text-sm text-yellow-700 flex items-start">
              <span class="mr-2 text-yellow-600">‚Ä¢</span>
              <span>{{ recommendation }}</span>
            </li>
            {% endfor %}
          </ul>
          
          <!-- Additional Safety Tips -->
          <div class="mt-4 pt-4 border-t border-yellow-200">
            <h4 class="font-medium text-yellow-800 mb-2">General Safety Tips:</h4>
            <ul class="text-xs text-yellow-700 space-y-1">
              <li>‚Ä¢ Always read ingredient labels carefully</li>
              <li>‚Ä¢ When in doubt, consult with a healthcare provider</li>
              <li>‚Ä¢ Keep emergency medication (like epinephrine) readily available</li>
              <li>‚Ä¢ Inform restaurants and hosts about your allergies</li>
            </ul>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- Recipe Content -->
    <div class="w-full flex flex-col md:flex-row gap-8 mb-8">
      <div class="flex-1">
        <h2 class="text-xl font-semibold mb-2 text-yellow-700">Ingredients</h2>
        <div class="bg-[#FFFBF2] rounded-lg p-4 border border-yellow-50 shadow-sm text-gray-800">
          <ul class="list-disc pl-5 space-y-2">
            {% for ingredient in ingredients %}
              <li>{{ ingredient }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
      <div class="flex-1">
        <h2 class="text-xl font-semibold mb-2 text-yellow-700">Directions</h2>
        <div class="bg-[#FFFBF2] rounded-lg p-4 border border-yellow-50 shadow-sm text-gray-800">
          <ol class="list-decimal pl-5 space-y-2">
            {% for instruction in instructions %}
              <li>{{ instruction }}</li>
            {% endfor %}
          </ol>
        </div>
      </div>
    </div>

    <!-- Recipe Metadata -->
    <div class="w-full mb-6">
      <div class="bg-gray-50 rounded-lg p-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-600">
          {% if recipe.times %}
          <div>
            <span class="font-medium">Cooking Time:</span>
            <span>{{ recipe.times }}</span>
          </div>
          {% endif %}
          <div>
            <span class="font-medium">Analysis Date:</span>
            <span>{% if recipe.analysis_result.analysis_date %}{{ recipe.analysis_result.analysis_date|date:"M d, Y" }}{% else %}Not analyzed{% endif %}</span>
          </div>
          <div>
            <span class="font-medium">Total Ingredients:</span>
            <span>{{ ingredients|length }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Navigation with Enhanced Actions -->
    <div class="flex flex-wrap gap-4 justify-center">
      <a href="/"
        class="inline-flex items-center px-6 py-2 border border-yellow-600 text-yellow-700 rounded-full font-semibold shadow hover:bg-yellow-50 transition">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Back to Search
      </a>
      
      <button onclick="window.print()" 
        class="inline-flex items-center px-6 py-2 bg-gray-600 text-white rounded-full font-semibold shadow hover:bg-gray-700 transition print:hidden">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
        </svg>
        Print Recipe
      </button>
      
      {% if can_annotate %}
      <a href="{% url 'annotate_recipe' recipe.id %}"
        class="inline-flex items-center px-6 py-2 bg-blue-600 text-white rounded-full font-semibold shadow hover:bg-blue-700 transition print:hidden">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
        </svg>
        {% if existing_annotation %}Edit{% else %}Add{% endif %} Annotation
      </a>
      {% endif %}
      
      <a href="{% url 'feedback_form' recipe.id %}"
        class="inline-flex items-center px-6 py-2 bg-purple-600 text-white rounded-full font-semibold shadow hover:bg-purple-700 transition print:hidden">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        Provide Feedback
      </a>
      
      <button onclick="copyIngredients()"
        class="inline-flex items-center px-6 py-2 bg-green-600 text-white rounded-full font-semibold shadow hover:bg-green-700 transition print:hidden">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
        </svg>
        Copy Ingredients
      </button>
      
      {% if recipe.original_url %}
      <a href="{{ recipe.original_url }}" target="_blank" rel="noopener noreferrer"
        class="inline-flex items-center px-6 py-2 bg-blue-600 text-white rounded-full font-semibold shadow hover:bg-blue-700 transition">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
        </svg>
        View Original
      </a>
      {% endif %}
    </div>
  </div>
</div>

<style>
.confidence-bar {
    width: 0%;
    transition: width 0.8s ease-in-out;
}
.allergen-confidence-bar {
    width: 0%;
    transition: width 0.6s ease-in-out;
}
.recipe-section {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.6s ease-out;
}
.recipe-section.visible {
    opacity: 1;
    transform: translateY(0);
}

/* Fallback for images when JavaScript is disabled */
img {
    opacity: 1 !important;
    transition: opacity 0.3s ease-in-out;
}

/* Only apply opacity 0 when JavaScript is enabled */
.js-enabled img {
    opacity: 0;
}
.js-enabled img.loaded {
    opacity: 1;
}

/* Print styles */
@media print {
    body {
        background: white !important;
        color: black !important;
    }
    
    .bg-\[#F0EBE1\], .bg-gradient-to-br, .bg-white, .bg-gray-50, .bg-yellow-50, .bg-red-50, .bg-orange-50, .bg-green-50 {
        background: white !important;
        border: 1px solid #ddd !important;
    }
    
    .shadow, .shadow-lg, .shadow-sm {
        box-shadow: none !important;
    }
    
    .print\\:hidden {
        display: none !important;
    }
    
    h1 {
        font-size: 24px !important;
        color: black !important;
    }
    
    h2 {
        font-size: 18px !important;
        color: black !important;
    }
    
    .text-gray-900, .text-gray-800, .text-gray-700, .text-gray-600 {
        color: black !important;
    }
    
    .text-yellow-700, .text-red-800, .text-orange-800, .text-green-800 {
        color: black !important;
    }
    
    .bg-yellow-100, .bg-red-100, .bg-orange-100, .bg-green-100 {
        background: #f5f5f5 !important;
        border: 1px solid #ddd !important;
    }
    
    .text-yellow-800, .text-red-800, .text-orange-800, .text-green-800 {
        color: black !important;
    }
    
    /* Hide interactive elements */
    button, .quick-view-btn, .favorite-btn {
        display: none !important;
    }
    
    /* Ensure content fits on page */
    .max-w-4xl {
        max-width: none !important;
    }
    
    .p-8 {
        padding: 20px !important;
    }
    
    /* Break pages appropriately */
    .recipe-section {
        page-break-inside: avoid;
    }
    
    /* Add recipe title to each page */
    @page {
        @top-center {
            content: "{{ recipe.title }}";
            font-size: 10px;
            color: #666;
        }
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Add js-enabled class to body for CSS targeting
        document.body.classList.add('js-enabled');
        
        // Enhanced confidence bar animations with better performance
        const animateConfidenceBars = () => {
            const confidenceBars = document.querySelectorAll('.confidence-bar');
            confidenceBars.forEach((bar, index) => {
                const confidence = bar.getAttribute('data-confidence');
                if (confidence) {
                    setTimeout(() => {
                        bar.style.width = confidence + '%';
                    }, 200 + (index * 100));
                }
            });
            
            // Animate allergen confidence bars
            const allergenConfidenceBars = document.querySelectorAll('.allergen-confidence-bar');
            allergenConfidenceBars.forEach((bar, index) => {
                const confidence = bar.getAttribute('data-confidence');
                if (confidence) {
                    setTimeout(() => {
                        bar.style.width = confidence + '%';
                    }, 400 + (index * 100));
                }
            });
        };

        // Enhanced intersection observer for scroll animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, observerOptions);

        // Add animations to recipe sections
        const mainContainer = document.querySelector('.max-w-4xl.w-full');
        if (mainContainer) {
            Array.from(mainContainer.children).forEach((section, index) => {
                if (section.classList.contains('w-full')) {
                    section.classList.add('recipe-section');
                    section.style.transitionDelay = `${index * 0.1}s`;
                    observer.observe(section);
                }
            });
        }

        // Enhanced copy functionality
        window.copyIngredients = function() {
            try {
                const ingredientsList = document.querySelector('ul.list-disc');
                if (ingredientsList) {
                    const ingredients = Array.from(ingredientsList.querySelectorAll('li'))
                        .map(li => li.textContent.trim())
                        .join('\n');
                    
                    navigator.clipboard.writeText(ingredients).then(() => {
                        showToast('Ingredients copied to clipboard!', 'success');
                    }).catch(() => {
                        showToast('Failed to copy ingredients', 'error');
                    });
                } else {
                    showToast('No ingredients found to copy', 'warning');
                }
            } catch (error) {
                showToast('Copy functionality not supported', 'warning');
            }
        };

        // Enhanced recipe title copy functionality
        const recipeTitle = document.querySelector('h1');
        if (recipeTitle) {
            recipeTitle.addEventListener('click', function() {
                try {
                    navigator.clipboard.writeText(this.textContent).then(() => {
                        showToast('Recipe title copied to clipboard!', 'success');
                    }).catch(() => {
                        showToast('Failed to copy to clipboard', 'error');
                    });
                } catch (error) {
                    showToast('Copy functionality not supported', 'warning');
                }
            });
            recipeTitle.style.cursor = 'pointer';
            recipeTitle.title = 'Click to copy recipe title';
        }

        // Enhanced toast notification system
        function showToast(message, type = 'info') {
            try {
                // Remove existing toasts
                const existingToasts = document.querySelectorAll('.toast');
                existingToasts.forEach(toast => toast.remove());

                // Create toast element with better styling
                const toast = document.createElement('div');
                toast.className = `toast fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-white transform translate-x-full transition-all duration-300 max-w-sm`;
                
                // Set color and icon based on type
                const toastConfig = {
                    success: { bg: 'bg-green-500', icon: '‚úì' },
                    error: { bg: 'bg-red-500', icon: '‚úï' },
                    warning: { bg: 'bg-yellow-500', icon: '‚ö†' },
                    info: { bg: 'bg-blue-500', icon: '‚Ñπ' }
                };
                
                const config = toastConfig[type] || toastConfig.info;
                toast.classList.add(config.bg);
                
                toast.innerHTML = `
                    <div class="flex items-center">
                        <span class="mr-2">${config.icon}</span>
                        <span class="text-sm font-medium">${message}</span>
                    </div>
                `;
                
                document.body.appendChild(toast);

                // Animate in
                requestAnimationFrame(() => {
                    toast.classList.remove('translate-x-full');
                });

                // Animate out and remove
                setTimeout(() => {
                    toast.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }, 4000);
            } catch (error) {
                console.error('Toast error:', error);
            }
        }

        // Enhanced keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Escape to go back
            if (e.key === 'Escape') {
                window.history.back();
            }
            
            // Ctrl/Cmd + C to copy recipe title
            if ((e.ctrlKey || e.metaKey) && e.key === 'c' && document.getSelection().toString() === '') {
                e.preventDefault();
                const recipeTitle = document.querySelector('h1');
                if (recipeTitle) {
                    try {
                        navigator.clipboard.writeText(recipeTitle.textContent).then(() => {
                            showToast('Recipe title copied to clipboard!', 'success');
                        }).catch(() => {
                            showToast('Failed to copy to clipboard', 'error');
                        });
                    } catch (error) {
                        showToast('Copy functionality not supported', 'warning');
                    }
                }
            }
            
            // Ctrl/Cmd + P to print
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                window.print();
            }
        });

        // Enhanced smooth scroll to sections
        const riskLevelBadge = document.querySelector('.bg-green-50, .bg-yellow-50, .bg-orange-50, .bg-red-50');
        if (riskLevelBadge) {
            riskLevelBadge.addEventListener('click', function() {
                const allergenSection = document.querySelector('.bg-gradient-to-r.from-red-50');
                if (allergenSection) {
                    allergenSection.scrollIntoView({ behavior: 'smooth' });
                }
            });
            riskLevelBadge.style.cursor = 'pointer';
            riskLevelBadge.title = 'Click to scroll to allergen details';
        }

        // Enhanced image loading with better error handling
        const images = document.querySelectorAll('img');
        images.forEach(img => {
            // If image is already loaded (cached), show it immediately
            if (img.complete && img.naturalHeight !== 0) {
                img.classList.add('loaded');
            } else {
                // Add event listeners for load and error
                img.addEventListener('load', function() {
                    this.classList.add('loaded');
                });
                img.addEventListener('error', function() {
                    this.classList.add('loaded');
                    this.style.filter = 'grayscale(100%)';
                    console.warn('Image failed to load:', this.src);
                });
                
                // Fallback: if image doesn't load within 3 seconds, show it anyway
                setTimeout(() => {
                    if (!img.classList.contains('loaded')) {
                        img.classList.add('loaded');
                        console.warn('Image loading timeout, showing anyway:', img.src);
                    }
                }, 3000);
            }
        });

        // Enhanced hover effects to allergen cards
        const allergenCards = document.querySelectorAll('.bg-white.rounded-lg.p-4.border.border-red-100');
        allergenCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 10px 25px rgba(0,0,0,0.1)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '';
            });
        });

        // Initialize animations
        animateConfidenceBars();
        
        // Mark page as loaded
        document.body.classList.add('loaded');
        console.log('Recipe detail page loaded successfully');
        
    } catch (err) {
        // If any error occurs, show the main content
        const allSections = document.querySelectorAll('.recipe-section');
        allSections.forEach(section => {
            section.classList.add('visible');
        });
        console.error('Recipe detail JS error:', err);
    }
});
</script>
{% endblock %}